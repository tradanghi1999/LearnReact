<!DOCTYPE html>
<html>
  <head></head>
  <body>
      <script>
          let cars ={
              "capacity": 20,
              "numbers": 2
          }

          let ids = [
                {   
                    "id": 142205,
                    "name": "Nghiax"
                },
                {   
                    "id": 142188,
                    "name":"Co"
                },
                { 
                    "id": 142168,
                    "name": "Trang" 
                },
                { 
                    "id": 142171,
                    "name": "Thang"
                },
                { 
                    "id": 142173,
                    "name":"Cuong" 
                },
                { 
                    "id": 142186,
                    "name":"Nga"
                },
                { 
                    "id": 142169,
                    "name":"Long"
                },
                { 
                    "id": 142179,
                    "name": "Tri"
                },
                { 
                    "id":142198,
                    "name": "Hung"
                },
                { 
                    "id": 16901,
                    "name":  "Anh Ruy"
                },
                { 
                    "id": 1125,
                    "name": "Anh Hieu"
                },
                { 
                    "id": 3306,
                    "name": "Anh Tin"
                },
                { 
                    "id": 16058,
                    "name": "Chi Xuyen"
                },
                { 
                    "id": 17113,
                    "name": "Chi Quyen"
                },
                { 
                    "id": 2061,
                    "name": "Chi Thuy"
                },
                { 
                    "id": 11653,
                    "name": "Anh Hoan"
                },
                { 
                    "id": 70445,
                    "name":"Anh Ky Ky"
                }
            ]

        let db = [
        {
            "id": 142205,
            "distances": [0,4,5,2,4,9,5,5,6,7,2,1,5,3,8,3,8],
            "timetravels":[0,0.17,0.21,0.1,0.17,0.34,0.23,0.21,0.24,0.26,0.1,0.05,0.21,0.14,0.3,0.14,0.3],
            "order": {
                "weight": 0,
                "long": 106.775174,
                "lat": 10.847981,
                "ServiceTime": 0,
                "timeWindow":[0,23.99]
            }
            
        },
        {
            "id": 142188,
            "distances": [4,0,3,3,8,5,1,9,3,4,6,4,2,8,1,8,4],
            "timetravels":[0.17,0,0.14,0.19,0.3,0.21,0.05,0.34,0.14,0.17,0.25,0.17,0.1,0.3,0.05,0.32,0.17],
            "order":{
                "weight": 7,
                "long": 106.77441,
                "lat": 10.841086,
                "ServiceTime": 0.7,
                "timeWindow":[8,13]
            }
        },
        {
            "id": 142168,
            "distances": [5,3,0,1,2,3,4,5,6,7,8,9,3,6,7,5,1],
            "timetravels":[0.21,0.14,0,0.05,0.1,0.14,0.17,0.21,0.24,0.26,0.3,0.34,0.14,0.24,0.26,0.21,0.05],
            "order":{
                "weight": 3,
                "long": 106.773538,
                "lat": 10.844492,
                "ServiceTime": 0.2,
                "timeWindow":[9,11]
            }
        },
        {
            "id": 142171,
            "distances": [2,3,1,0,1,4,3,7,5,6,7,8,2,5,9,2,6],
            "timetravels":[0.1,0.19,0.05,0,0.05,0.17,0.14,0.26,0.21,0.24,0.26,0.3,0.1,0.21,0.4,0.11,0.24],
            "order":{
                "weight": 10,
                "long": 106.763187,
                "lat": 10.852758,
                "ServiceTime": 3,
                "timeWindow":[12,15]
            }
        },
        {
            "id": 142173,
            "distances": [4,8,2,1,0,5,6,6,1,5,3,3,9,2,3,1,2],
            "timetravels":[0.17,0.3,0.1,0.05,0,0.21,0.26,0.24,0.09,0.21,0.14,0.14,0.34,0.1,0.14,0.07,0.1],
            "order":{
                "weight": 4,
                "long": 106.768171,
                "lat": 10.85033,
                "ServiceTime": 1.5,
                "timeWindow":[18,20]
            }
        },
        {
            "id": 142186,
            "distances": [9,5,3,4,5,0,7,3,2,6,7,5,3,1,6,3,4],
            "timetravels":[0.34,0.21,0.14,0.17,0.21,0,0.26,0.14,0.11,0.24,0.27,0.21,0.14,0.05,0.32,0.14,0.17],
            "order":{
                "weight": 8,
                "long": 106.770891,
                "lat": 10.849677,
                "ServiceTime": 2,
                "timeWindow":[11,14]
            }
        },
        {
            "id": 142169,
            "distances": [5,1,4,3,6,7,0,1,4,8,9,5,2,4,3,2,4],
            "timetravels":[0.23,0.05,0.17,0.14,0.26,0.26,0,0.05,0.18,0.3,0.34,0.21,0.1,0.17,0.14,0.1,0.17],
            "order":{
                "weight": 6,
        "long": 106.776231,
        "lat": 10.874757,
        "ServiceTime": 1.2,
        "timeWindow":[10,12]
            }
        },
        {
            "id": 142179,
            "distances": [5,9,5,7,6,3,1,0,7,1,5,4,7,8,7,4,3],
            "timetravels":[0.21,0.34,0.21,0.26,0.24,0.14,0.05,0,0.26,0.05,0.21,0.17,0.28,0.3,0.26,0.17,0.14],
            "order":{
                "weight": 5,
                "long": 106.778244,
                "lat": 10.870165,
                "ServiceTime": 0.5,
                "timeWindow":[14,18]
            }
        },
        {
            "id": 142198,
            "distances": [6,3,6,5,1,2,4,7,0,6,4,6,4,2,3,6,3],
            "timetravels":[0.24,0.14,0.24,0.21,0.09,0.11,0.18,0.26,0,0.24,0.17,0.24,0.17,0.12,0.16,0.24,0.14],
            "order":{
                "weight": 1,
                "long": 106.761178,
                "lat": 10.858531,
                "ServiceTime": 0.8,
                "timeWindow":[16,17]
            }
        },
        {
            "id": 16901,
            "distances": [7,4,7,6,5,6,8,1,6,0,9,1,5,1,2,8,5],
            "timetravels":[0.26,0.17,0.26,0.24,0.21,0.24,0.3,0.05,0.24,0,0.34,0.05,0.21,0.05,0.1,0.3,0.21],
            "order":{
                "weight": 2,
                "long": 106.763545,
                "lat": 10.856093,
                "ServiceTime": 1.3,
                "timeWindow":[18.5,21]
            }
        },
        {
            "id": 1125,
            "distances": [2,6,8,7,3,7,9,5,4,9,0,2,1,7,2,7,4],
            "timetravels":[0.1,0.25,0.3,0.26,0.14,0.27,0.34,0.21,0.17,0.34,0,0.1,0.07,0.26,0.1,0.26,0.17],
            "order":{
                "weight": 9,
                "long": 106.761683,
                "lat": 10.86049,
                "ServiceTime": 2.3,
                "timeWindow":[19,22]
            }
        },
        {
            "id": 3306,
            "distances": [1,4,9,8,3,5,5,4,6,1,2,0,6,5,3,9,7],
            "timetravels":[0.05,0.17,0.34,0.3,0.14,0.21,0.21,0.17,0.24,0.05,0.1,0,0.24,0.21,0.14,0.36,0.26],
            "order":{
                "weight": 3,
                "long": 106.762352,
                "lat": 10.862985,
                "ServiceTime": 0.1,
                "timeWindow":[8,9]
            }
        },
        {
            "id": 16058,
            "distances": [5,2,3,2,9,3,2,7,4,5,1,6,0,4,4,7,9],
            "timetravels":[0.21,0.1,0.14,0.1,0.34,0.14,0.1,0.28,0.17,0.21,0.07,0.24,0,0.17,0.17,0.26,0.44],
            "order":{
                "weight": 8,
                "long": 106.772033,
                "lat": 10.860827,
                "ServiceTime": 1.1,
                "timeWindow":[9,15]
            }
        },
        {
            "id": 17113,
            "distances": [3,8,6,5,2,1,4,8,2,1,7,5,4,0,6,4,2],
            "timetravels":[0.14,0.3,0.24,0.21,0.1,0.05,0.17,0.3,0.12,0.05,0.26,0.21,0.17,0,0.24,0.17,0.1],
            "order":{
                "weight": 6,
                "long": 106.772033,
                "lat": 10.860827,
                "ServiceTime": 1.7,
                "timeWindow":[14,16]
            }
        },
        {
            "id": 2061,
            "distances": [8,1,7,9,3,6,3,7,3,2,2,3,4,6,0,6,1],
            "timetravels":[0.3,0.05,0.26,0.4,0.14,0.32,0.14,0.26,0.16,0.1,0.1,0.14,0.17,0.24,0,0.24,0.05],
            "order":{
                "weight": 2,
        "long": 106.773386,
        "lat": 10.860449,
        "ServiceTime": 0.2,
        "timeWindow":[8,16]
            }
        },
        {
            "id": 11653,
            "distances": [3,8,5,2,1,3,2,4,6,8,7,9,7,4,6,0,8],
            "timetravels":[0.14,0.32,0.21,0.11,0.07,0.14,0.1,0.17,0.24,0.3,0.26,0.36,0.26,0.17,0.24,0,0.3],
            "order":{
                "weight": 7,
                "long": 106.781517,
                "lat": 10.850289,
                "ServiceTime":1,
                "timeWindow":[16,21]
            }
        },
        {
            "id": 70445,
            "distances": [8,4,1,6,2,4,4,3,3,5,4,7,9,2,1,8,0],
            "timetravels":[0.3,0.17,0.05,0.24,0.1,0.17,0.17,0.14,0.14,0.21,0.17,0.26,0.44,0.1,0.05,0.3,0],
            "order":{
                "weight": 4,
                "long": 106.813917,
                "lat": 10.848794,
                "ServiceTime":0.5,
                "timeWindow":[10,20]
            }
        }
    ]
      </script>

      <script>
          let vrp = {
            routes : [],
            import : function(ids, db)
            {
                this.ids = ids;
                this.db = db;
            },
            importStartTime(startTime)
            {
                this.startTime = startTime;
            },
            importFleet(fleets)
            {
                this.cars = cars;
                this.bikes = bikes;
            },
            importCars(cars)
            {
                this.cars = cars
            },
            createNewRoute : function(){
                let route = [0,0]
                this.routes.push(route);
            },
            getRoutes: function()
            {
                return this.routes.filter(r => r.length > 2)
            },
            insertNode: function(route, node)
            {
                route.shift()
                route.unshift(node)
                route.unshift(0)
            },
            isRouteEmty : function(route)
            {
                if(route.length < 3)
                    return true
                return false
            },
            getTravelTime: function(startNode, endNode)
            {
                let timetravels = db.map(x => x.timetravels)
                return timetravels[startNode][endNode]
            },
            getSortedTravelTimes: function(startNode)
            {
                let timetravels = this.db.map(x => x.timetravels)
                let unSortedTimeTravels = timetravels[startNode].map(function(x,i){
                    return[[startNode,i],x];
                })

                let sortedTimeTravels = unSortedTimeTravels .map(x=>x)
                                                            .sort((a, b) =>{
                                                                if(a[1] == b[1])
                                                                    return 0
                                                                if(a[1] < b[1])
                                                                    return -1
                                                                return 1
                                                            })
                return sortedTimeTravels.filter(x => x[0][0]!=x[0][1])

            },
            getSortedTravelTimesOnEndNodes: function(endNode)
            {
                let timetravels = this.db.map(x => x.timetravels)
                let unSortedTimeTravels = timetravels.map(tt => tt[endNode])
                                                    .map(function(x,i){
                                                        return [[i,endNode],x]
                                                    })
                let sortedTimeTravels = unSortedTimeTravels.map(x=>x)
                                                            .sort((a, b) =>{
                                                                if(a[1] == b[1])
                                                                    return 0
                                                                if(a[1] < b[1])
                                                                    return -1
                                                                return 1
                                                            })
                return sortedTimeTravels.filter(x => x[0][0]!=x[0][1])
            },
            getServiceTime: function(node)
            {
                let serviceTimes = db.map(x => x.order.ServiceTime)
                return serviceTimes[node]
            },
            getTimeWindow: function(node)
            {
                let timeWindows = db.map(x => x.order.timeWindow)
                return timeWindows[node]
            },
            calculateTimeAfterServiced: function(startNode, endNode, timeStart)
            {
                let timeArrived = timeStart + 
                                    this.getTravelTime(startNode, endNode); 
                //arrive early
                let timeToCallCus;
                if (timeArrived < this.getTimeWindow(endNode)[0])
                    timeToCallCus = this.getTimeWindow(endNode)[0]
                else
                    timeToCallCus = timeArrived

                return timeToCallCus+    
                        this.getServiceTime(endNode)
            },
            isArrivedOnTime(node, arrivedTime)
            {
                let timeWindow = this.getTimeWindow(node)
                return arrivedTime < timeWindow[1]
            },
            isInCapacity : function(route)
            {
                let weights = db.filter(x => x!=db[0])
                                .map(x => x.order.weight)
                let routeTotalWeight = route.filter(x=> x!=0)
                                            .map(x => weights[x-1])
                                            .reduce((a,b) => a+b)
                return routeTotalWeight <= this.cars.capacity;

            },

            isRouteAchievable: function(route, startTime)
            {
                let sTime = startTime;
                for(let i = 0; i < route.length - 3; i++)
                {
                    sTime = this.calculateTimeAfterServiced(route[i], route[i+1], sTime)
                }
                let timeArrivedLastNode = sTime + this.getTravelTime(route[route.length - 3], route[route.length - 2])
                return this.isArrivedOnTime(route[route.length - 2], timeArrivedLastNode) &&
                        this.isInCapacity(route)
                //return false
            },
            isOKtoPut: function(route, node, startTime)
            {
                if(this.isRouteEmty(route))
                    return true
                
                let copiedRoute = route.map(x=>x)
                this.insertNode(copiedRoute, node)

                return this.isRouteAchievable(copiedRoute,startTime)
            },

            createCustomers : function(numberOfCustomers)
            {
                let cus = []
                for(let i = 1; i < numberOfCustomers; i++)
                {
                    cus.push(i)
                }
                return cus
            },
            find : function()
            {
                let cus = this.createCustomers(this.ids.length)
                while(cus.length > 0)
                {
                    if(this.routes.length == 0)
                        this.createNewRoute();

                    let latestRoute = this.routes[this.routes.length - 1]
                    let sortedTimeTravels = this.getSortedTravelTimesOnEndNodes(latestRoute[0])
                                                .filter(x => cus.includes(x[0][0]))
                                                
                    
                    while(cus.length > 0 && sortedTimeTravels.length > 0)
                    {
                        if(this.isOKtoPut(latestRoute, sortedTimeTravels[0][0][0],this.startTime))
                        {
                            this.insertNode(latestRoute,sortedTimeTravels[0][0][0])
                            cus = cus.filter(x => x!= sortedTimeTravels[0][0][0])
                        }
                        sortedTimeTravels.shift()
                        
                    }
                    this.createNewRoute()
                }
            }

            
            
          }

          
          vrp.import(ids, db)
          vrp.importCars(cars)
          //console.log(vrp.calculateTimeAfterServiced(0,1,8))
          vrp.importStartTime(7)
          vrp.find()
          console.log(vrp.getSortedTravelTimes(1))
          console.log(vrp.getSortedTravelTimesOnEndNodes(1))
          console.log(vrp.getRoutes())


      </script>

      <script>
          let vrpQA = {
            importDb : function(ids, db)
            {
                this.ids = ids;
                this.db = db;
            },
            importCars(cars)
            {
                this.cars = cars
            },
            importVRP(vrp)
            {
                this.vrp = vrp
            },
            importStartTime(startTime)
            {
                this.startTime = startTime;
            },
            prepareVRPforTesting()
            {
                this.vrp.find()
            },
            getTravelTime: function(startNode, endNode)
            {
                let timetravels = this.db.map(x => x.timetravels)
                return timetravels[startNode][endNode]
            },
            getServiceTime: function(node)
            {
                let serviceTimes = this.db.map(x => x.order.ServiceTime)
                return serviceTimes[node]
            },
            getTimeWindow: function(node)
            {
                let timeWindows = this.db.map(x => x.order.timeWindow)
                return timeWindows[node]
            },
            isInCapacity(route)
            {
                let weights = this.db.filter(x => x!=db[0])
                                .map(x => x.order.weight)
                let routeTotalWeight = route.filter(x=> x!=0)
                                            .map(x => weights[x-1])
                                            .reduce((a,b) => a+b)

                console.log("route total weights: " + 
                            routeTotalWeight + " " +
                            (routeTotalWeight <= this.cars.capacity?
                            "isInCapacity":
                            "isNotInCapacity"))
                return routeTotalWeight <= this.cars.capacity; 
            },
            capacityTest()
            {
                let routes = this.vrp.getRoutes()
                let result = routes.map(r => this.isInCapacity(r))
                                        .some(r => r == false)
                console.log(result?
                            "capacity Test Not Pass":
                            "Pass Capacity Test")
            },
            timeWindowTest()
            {
                let routes = this.vrp.getRoutes()
                let startNodes = routes.map(r => r.slice(0, r.length-1))
                let endNodes = routes.map(r => r.slice(1, r.length))
                let startNodesEndNodes = startNodes.map(function(x, i){
                    let sts = x
                    let eds = endNodes[i]
                    return sts.map(function(y,j){
                        return [y, eds[j]]
                    })
                })
                let travelTimes = startNodesEndNodes.map(x => x.map(
                    y => this.getTravelTime(y[0], y[1])
                ))
                let timeWindows = routes.map(r => 
                                                r.filter(node => node!=0)
                                                .map(node => this.getTimeWindow(node))
                                            )
                let serviceTimes = routes.map(r => 
                                                r.filter(node => node!=0)
                                                .map(node => this.getServiceTime(node))
                                            )

                

                console.log(routes)
                console.log(startNodesEndNodes)
                console.log(travelTimes)
                console.log(serviceTimes)
                console.log(timeWindows)
                
            }




          }

          vrpQA.importDb(ids, db)
          vrpQA.importVRP(vrp)
          vrpQA.importCars(cars)
          //vrpQA.prepareVRPforTesting()
          vrpQA.capacityTest()
          vrpQA.timeWindowTest()
      </script>
  </body>
</html>